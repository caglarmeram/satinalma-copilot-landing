<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>√ñdeme - Satƒ±nalma CoPilot</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .container{max-width:1200px;width:100%}
    .payment-wrapper{display:grid;grid-template-columns:1fr 1fr;gap:40px;align-items:start}
    .card{background:#fff;border-radius:20px;padding:40px;box-shadow:0 20px 40px rgba(0,0,0,.1)}
    .card-header{text-align:center;margin-bottom:30px}
    .card-title{font-size:2rem;font-weight:700;color:#1e293b;margin-bottom:8px}
    .card-subtitle{color:#64748b;font-size:1.1rem}
    .plan-card{background:linear-gradient(135deg,#dbeafe 0%,#bfdbfe 100%);border-radius:12px;padding:24px;margin-bottom:24px;border-left:4px solid #2563eb}
    .plan-name{font-size:1.5rem;font-weight:700;color:#1e293b;margin-bottom:8px}
    .plan-price{font-size:2rem;font-weight:800;color:#2563eb;margin-bottom:8px}
    .features-list{list-style:none;margin-top:16px}
    .features-list li{display:flex;align-items:center;gap:8px;padding:4px 0;color:#475569;font-size:.9rem}
    .info-item{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #f1f5f9}
    .info-item:last-child{border-bottom:none}
    .label{color:#64748b;font-weight:500}
    .value{color:#1e293b;font-weight:600}
    .payment-method{border:2px solid #2563eb;background:#f8faff;border-radius:12px;padding:20px;text-align:center;margin-bottom:20px}
    .method-icon{font-size:2rem;margin-bottom:8px}
    .method-name{font-weight:600;color:#1e293b;margin-bottom:4px}
    .summary-section{background:#f8fafc;border-radius:12px;padding:20px;margin-bottom:30px}
    .summary-title{font-weight:600;color:#1e293b;margin-bottom:16px}
    .summary-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #e2e8f0}
    .summary-item:last-child{border-bottom:none;font-weight:600;font-size:1.1rem;color:#1e293b;margin-top:8px;padding-top:16px;border-top:2px solid #e2e8f0}
    .pay-button{width:100%;background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;border:none;padding:16px 24px;border-radius:12px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all .3s ease;margin-bottom:16px}
    .pay-button:hover{background:linear-gradient(135deg,#1d4ed8,#1e40af);transform:translateY(-2px)}
    .pay-button:disabled{background:#94a3b8;cursor:not-allowed;transform:none}
    .security-note{text-align:center;color:#64748b;font-size:.9rem;line-height:1.5}
    .back-link{text-align:center;margin-top:20px}
    .back-link a{color:#2563eb;text-decoration:none;font-weight:500}
    .loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9999}
    .loading-content{background:#fff;padding:40px;border-radius:20px;text-align:center}
    .spinner{width:40px;height:40px;border:4px solid #f3f4f6;border-top:4px solid #2563eb;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .error-message{background:#fee2e2;border:1px solid #f87171;border-radius:8px;padding:20px;margin:20px 0;text-align:center;color:#dc2626}
    .success-message{background:#dcfce7;border:1px solid #10b981;border-radius:8px;padding:16px;margin:16px 0;text-align:center;color:#059669}
    @media (max-width:768px){.payment-wrapper{grid-template-columns:1fr;gap:20px}.card{padding:24px}}
  </style>
</head>
<body>
  <div class="container">
    <div class="payment-wrapper">
      <!-- Kullanƒ±cƒ± / Plan kartƒ± -->
      <div class="card">
        <div class="card-header">
          <h1 class="card-title">ü§ñ Satƒ±nalma CoPilot</h1>
          <p class="card-subtitle">Plan Y√ºkseltme & √ñdeme</p>
        </div>

        <div class="plan-card" id="planCard">
          <div class="plan-name" id="planName">Plan Y√ºkleniyor...</div>
          <div class="plan-price" id="planPrice">$0.00/ay</div>
          <ul class="features-list" id="planFeatures"></ul>
        </div>

        <div id="userInfo">
          <div class="info-item"><span class="label">Ad Soyad:</span><span class="value" id="userName">Y√ºkleniyor...</span></div>
          <div class="info-item"><span class="label">≈ûirket:</span><span class="value" id="companyName">Y√ºkleniyor...</span></div>
          <div class="info-item"><span class="label">WhatsApp:</span><span class="value" id="phoneNumber">Y√ºkleniyor...</span></div>
          <div class="info-item"><span class="label">Mevcut Plan:</span><span class="value" id="currentPlan">Y√ºkleniyor...</span></div>
        </div>

        <div class="success-message" style="margin-top:20px">‚ö° √ñdeme sonrasƒ± WhatsApp asistanƒ±nƒ±z anƒ±nda aktifle≈üir!</div>
      </div>

      <!-- √ñdeme kartƒ± -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">G√ºvenli √ñdeme</h2>
          <p class="card-subtitle">Planƒ±nƒ±zƒ± hemen aktifle≈ütirin</p>
        </div>

        <div class="payment-method">
          <div class="method-icon">üáπüá∑</div>
          <div class="method-name">PayTR G√ºvenli √ñdeme</div>
          <div style="font-size:.85rem;color:#64748b;margin-top:8px">Visa, Mastercard, Troy - T√ºm kartlar desteklenir</div>
        </div>

        <div class="summary-section">
          <h4 class="summary-title">Sipari≈ü √ñzeti</h4>
          <div class="summary-item"><span>Plan:</span><span id="summaryPlan">Y√ºkleniyor...</span></div>
          <div class="summary-item"><span>S√ºre:</span><span id="summaryDuration">-</span></div>
          <div class="summary-item"><span>Mesaj Kotasƒ±:</span><span id="summaryQuota">-</span></div>
          <div class="summary-item"><span>USD Fiyat:</span><span id="summaryUSD">$0.00</span></div>
        </div>

        <button class="pay-button" id="payButton" onclick="processPayment()" disabled>
          <span id="payButtonText">√ñdemeyi Ba≈ülat</span>
        </button>

        <div class="security-note">
          üîí √ñdemeleriniz SSL ile ≈üifrelenir<br>
          üí∞ ƒ∞lk 14 g√ºn para iade garantisi<br>
          üö´ Otomatik yenilenme yok
        </div>

        <div class="back-link"><a href="index.html">‚Üê Ana Sayfaya D√∂n</a></div>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <h3 id="loadingText">√ñdeme ƒ∞≈üleniyor...</h3>
      <p>L√ºtfen sayfayƒ± kapatmayƒ±n</p>
    </div>
  </div>

  <script>
    // === CONFIG ===
    // Backend URL ‚Äî Hetzner'deki Express API
    const API_BASE_URL = "https://api.satinalmacopilot.com";

    // Plan konfig√ºrasyonu (USD fiyatlar)
    const PRICING = {
      monthly: {
        basic: { price: 7.95, quota: 500,  name: 'Basic' },
        pro:   { price: 17.95, quota: 1500, name: 'Pro'   },
        max:   { price: 39.95, quota: 5000, name: 'Max'   }
      },
      yearly: {
        basic: { price: 47.40, quota: 6000,  name: 'Basic' },
        pro:   { price: 107.40, quota: 18000, name: 'Pro'   },
        max:   { price: 239.40, quota: 60000, name: 'Max'   }
      }
    };

    const FEATURES = {
      basic: ['‚úÖ Tedarik√ßi Bulma','‚úÖ Basit RFQ Olu≈üturma','‚úÖ Temel Risk Analizi','‚ùå API Eri≈üimi'],
      pro:   ['‚úÖ T√ºm Basic √ñzellikler','‚úÖ Geli≈ümi≈ü RFQ Y√∂netimi','‚úÖ Detaylƒ± Risk Analizi','‚úÖ API Eri≈üimi'],
      max:   ['‚úÖ T√ºm Pro √ñzellikleri','‚úÖ √ñncelikli Destek','‚úÖ ERP Entegrasyonu','‚úÖ √ñzel Raporlama']
    };

    // Global state
    let currentUser = null;
    let selectedPlan = 'pro';
    let selectedBilling = 'monthly';

    document.addEventListener('DOMContentLoaded', async () => {
      // URL parametreleri
      const params = new URLSearchParams(location.search);
      const phone   = params.get('phone');
      const plan    = params.get('plan')    || 'pro';
      const billing = params.get('billing') || 'monthly';

      // üîß Normalize edici yardƒ±mcƒ± (annual ‚Üí yearly)
      const normalizeBilling = (b) => {
      const v = String(b || '').toLowerCase();
      return v === 'annual' ? 'yearly' : v;  // tek fark burada
      };
      if (!phone) {
        showError('Telefon numarasƒ± gerekli. Ana sayfaya y√∂nlendiriliyorsunuz.');
        setTimeout(()=> location.href = 'index.html', 2500);
        return;
      }

      selectedPlan    = String(plan || 'pro').toLowerCase();
      selectedBilling = normalizeBilling(billing);

      try {
        await loadUserData(phone);
        updatePlanDisplay();
        updateSummary();
        enablePayButton();
      } catch (e) {
        console.error(e);
        showError('Sayfa y√ºklenirken hata olu≈ütu: ' + (e?.message || e));
      }
    });

    // Kullanƒ±cƒ± profili ‚Üí backend
    async function loadUserData(phone) {
      const clean = (phone||'').replace(/[^\d+]/g,'');
      const res = await fetch(`${API_BASE_URL}/api/user/profile?phone=${encodeURIComponent(clean)}`);
      if (!res.ok) throw new Error('Kullanƒ±cƒ± bulunamadƒ±');
      const user = await res.json();
      currentUser = user;
      displayUserInfo(user);
    }

    function displayUserInfo(user) {
      document.getElementById('userName').textContent = user.name || 'Belirtilmemi≈ü';
      document.getElementById('companyName').textContent = user.company_name || 'Belirtilmemi≈ü';
      document.getElementById('phoneNumber').textContent = user.contact_phone || 'Belirtilmemi≈ü';
      document.getElementById('currentPlan').textContent = (user.subscription_plan || 'trial').toUpperCase();
    }

    function updatePlanDisplay() {
      const plan = PRICING[selectedBilling][selectedPlan];
      document.getElementById('planName').textContent  = `${plan.name} Plan`;
      document.getElementById('planPrice').textContent = `$${plan.price}/${selectedBilling==='monthly'?'ay':'yƒ±l'}`;
      document.getElementById('planFeatures').innerHTML =
        FEATURES[selectedPlan].map(x=>`<li>${x}</li>`).join('');
    }

    function updateSummary() {
      const plan = PRICING[selectedBilling][selectedPlan];
      document.getElementById('summaryPlan').textContent     = plan.name;
      document.getElementById('summaryDuration').textContent = selectedBilling==='monthly'?'1 Ay':'1 Yƒ±l';
      document.getElementById('summaryQuota').textContent    = plan.quota.toLocaleString() + ' mesaj';
      document.getElementById('summaryUSD').textContent      = '$' + plan.price.toFixed(2);
      document.getElementById('payButtonText').textContent   = `$${plan.price.toFixed(2)} √ñde`;
    }

    function enablePayButton(){ document.getElementById('payButton').disabled = false; }

    // √ñdeme akƒ±≈üƒ±
    async function processPayment(){
      if (!currentUser){ showError('Kullanƒ±cƒ± bilgisi bulunamadƒ±'); return; }
      const plan = PRICING[selectedBilling][selectedPlan];

      showLoading('√ñdeme hazƒ±rlanƒ±yor‚Ä¶');

      try{
        // Backend‚Äôte √∂deme intent‚Äôi olu≈ütur
        const body = {
          phone: currentUser.contact_phone,
          plan: selectedPlan,                // 'basic' | 'pro' | 'max'
          billing_cycle: selectedBilling,    // 'monthly' | 'yearly'
          amount: plan.price                 // USD fiyat (backend kuru √ßevirebilir / PayTR TRY ise uyarladƒ±k)
        };

        const res = await fetch(`${API_BASE_URL}/api/payment/create`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        const out = await res.json();
        if (!res.ok || !out.success || !out.token){
          throw new Error(out.details || out.error || 'Payment creation failed');
        }

        hideLoading();
        openPayTRIframe(out.token, out.order_id);

      }catch(err){
        console.error(err);
        hideLoading();
        showError(`√ñdeme i≈ülemi ba≈ülatƒ±lamadƒ±: ${err.message}`);
      }
    }

    // PayTR iframe + status polling
    function openPayTRIframe(token, orderId){
      const overlay = document.createElement('div');
      overlay.id='paytr-iframe-container';
      overlay.style.cssText = `
        position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:10000;
        display:flex;align-items:center;justify-content:center;`;
      const close = document.createElement('button');
      close.textContent='‚úï';
      close.style.cssText=`
        position:absolute;top:20px;right:20px;background:#fff;border:none;border-radius:50%;
        width:40px;height:40px;cursor:pointer;font-size:20px;z-index:10001;`;
      close.onclick=()=>{ if(confirm('√ñdemeyi iptal etmek istiyor musunuz?')) document.body.removeChild(overlay); };

      const iframe = document.createElement('iframe');
      iframe.src = `https://www.paytr.com/odeme/guvenli/${token}`;
      iframe.style.cssText = `width:90%;max-width:800px;height:90%;max-height:600px;border:none;border-radius:10px;background:#fff;`;

      overlay.appendChild(close);
      overlay.appendChild(iframe);
      document.body.appendChild(overlay);

      // Polling
      const poll = setInterval(async ()=>{
        try{
          const r = await fetch(`${API_BASE_URL}/api/payment/status/${orderId}`);
          const j = await r.json();
          if (j.status === 'completed'){
            clearInterval(poll);
            if (document.body.contains(overlay)) document.body.removeChild(overlay);
            location.href = `success.html?order=${orderId}&phone=${encodeURIComponent(currentUser.contact_phone)}&plan=${encodeURIComponent(selectedPlan)}&billing=${encodeURIComponent(selectedBilling)}&payment=success`;
          }else if (j.status === 'failed'){
            clearInterval(poll);
            if (document.body.contains(overlay)) document.body.removeChild(overlay);
            location.href = `fail.html?order=${orderId}&phone=${encodeURIComponent(currentUser.contact_phone)}`;
          }
        }catch(e){ /* sessiz ge√ß */ }
      }, 3000);

      // 10 dakikada zaman a≈üƒ±mƒ±
      setTimeout(()=> clearInterval(poll), 600000);
    }

    // UI helpers
    function showLoading(msg){ document.getElementById('loadingText').textContent = msg; document.getElementById('loadingOverlay').style.display='flex'; }
    function hideLoading(){ document.getElementById('loadingOverlay').style.display='none'; }
    function showError(message){
      const div = document.createElement('div');
      div.className='error-message';
      div.innerHTML = `<h3>‚ö†Ô∏è Hata</h3><p>${message}</p><button onclick="location.reload()" style="background:#dc2626;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;margin-top:10px">üîÑ Tekrar Dene</button>`;
      const firstCard = document.querySelector('.card');
      firstCard.parentNode.insertBefore(div, firstCard.nextSibling);
    }
  </script>
</body>
</html>
