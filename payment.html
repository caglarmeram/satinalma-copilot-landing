<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Satınalma CoPilot – Ödeme</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0b1220; --card:#101a2f; --muted:#93a4bf; --text:#e9eef8; --primary:#4f8cff; --ok:#19c37d; --warn:#f6a609; --danger:#ff6b6b; }
    * { box-sizing:border-box }
    body { margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:linear-gradient(160deg,#0b1220,#0d1325,#0a0f1c); color:var(--text); }
    .wrap { max-width:1100px; margin:0 auto; padding:24px; }
    .header { display:flex; align-items:center; gap:12px; }
    .logo { width:44px; height:44px; border-radius:12px; background:#121d35; display:grid; place-items:center; font-weight:800; color:#9cc0ff; }
    h1 { font-size:26px; margin:10px 0 2px }
    .muted { color:var(--muted); font-size:14px }
    .grid { margin-top:24px; display:grid; grid-template-columns: 1.2fr 1fr; gap:20px }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr; } }
    .card { background:linear-gradient(180deg,#0f1930,#0d172b); border:1px solid #1f2a44; border-radius:16px; padding:18px; box-shadow:0 8px 30px rgba(0,0,0,.25) }
    .secTitle { font-weight:700; font-size:16px; margin:0 0 10px }
    label { display:block; font-size:13px; color:var(--muted); margin:10px 0 6px }
    input,select { width:100%; background:#0b1326; border:1px solid #1e2b48; color:var(--text); padding:10px 12px; border-radius:10px; outline:none }
    input:focus { border-color:#355aa5; box-shadow:0 0 0 2px rgba(79,140,255,.15) }
    .plans { display:grid; grid-template-columns: repeat(3,1fr); gap:12px; margin-top:10px }
    @media (max-width:900px){ .plans { grid-template-columns:1fr } }
    .plan { border:1px solid #1f2a44; border-radius:14px; padding:14px; background:#0f1830; cursor:pointer; position:relative; }
    .plan[data-selected="true"] { outline:2px solid var(--primary); box-shadow:0 0 0 4px rgba(79,140,255,.15) inset; }
    .planTitle { font-weight:700; }
    .price { font-size:22px; font-weight:800; margin-top:6px }
    .quota { font-size:12px; color:#a9b7d3; }
    .billToggle { display:flex; gap:8px; align-items:center; margin-top:8px; }
    .switch { position:relative; width:56px; height:30px; background:#172242; border-radius:999px; border:1px solid #24335a; cursor:pointer }
    .switch::after { content:""; position:absolute; top:3px; left:3px; width:24px; height:24px; background:#eaf1ff; border-radius:50%; transition:.2s }
    .switch[data-mode="yearly"]::after { left:29px }
    .badge { font-size:11px; padding:3px 8px; border-radius:999px; background:#13224a; color:#9fc2ff; border:1px solid #2a3f76 }
    .summaryRow { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #1f2a44; }
    .summaryRow:last-child { border-bottom:0 }
    .cta { width:100%; margin-top:14px; padding:14px 16px; font-weight:800; border-radius:12px; border:0; background:linear-gradient(135deg,#568dff,#3a6ee8); color:white; cursor:pointer }
    .cta[disabled] { opacity:.6; cursor:not-allowed }
    .banner { display:none; border:1px solid #3a2a1a; background:linear-gradient(180deg,#2a1b10,#23160e); color:#ffd9a8; padding:12px; border-radius:10px; margin:10px 0 }
    .banner.show { display:block }
    .ok { color:var(--ok) } .warn { color:var(--warn) } .danger { color:var(--danger) }
    .iframeWrap { display:none; margin-top:12px; border:1px solid #1f2a44; border-radius:12px; overflow:hidden; height:640px; background:#0b1326 }
    iframe { width:100%; height:100%; border:0 }
    .foot { margin-top:30px; font-size:12px; color:#7f8fb1; text-align:center }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="logo">SC</div>
      <div>
        <h1>Ödeme ve Plan Seçimi</h1>
        <div class="muted">Denemeniz bittiyse aboneliğinizi başlatın; aktifsiniz ve devam etmek istiyorsanız sürenizi uzatın ya da kota ekleyin.</div>
      </div>
    </div>

    <!-- PASSIVE/EXPIRED uyarı bandı -->
    <div id="passiveBanner" class="banner">Hesabınız <b>PASSIVE</b> durumda. Devam etmek için bir plan seçerek ödemeyi tamamlayın.</div>

    <div class="grid">
      <!-- SOL: Kullanıcı & Plan -->
      <div class="card">
        <h3 class="secTitle">Bilgileriniz</h3>
        <label>Ad Soyad</label>
        <input id="fullName" placeholder="Ad Soyad" autocomplete="name" />
        <label>Şirket</label>
        <input id="company" placeholder="Şirket" autocomplete="organization" />
        <label>Telefon (WhatsApp)</label>
        <input id="phone" placeholder="+90..." autocomplete="tel" />

        <h3 class="secTitle" style="margin-top:14px">Fatura Dönemi</h3>
        <div class="billToggle">
          <span>Aylık</span>
          <div id="billingSwitch" class="switch" data-mode="monthly" role="switch" aria-label="Faturalama Dönemi"></div>
          <span>Yıllık <span class="badge">% ~2 ay bedava</span></span>
        </div>

        <h3 class="secTitle" style="margin-top:14px">Plan Seç</h3>
        <div id="plans" class="plans">
          <!-- data-* fiyat/kota DOM’dan okunuyor -->
          <div class="plan" data-plan="basic" data-monthly-price="9"  data-yearly-price="90"  data-monthly-quota="200"  data-yearly-quota="2400">
            <div class="planTitle">Basic</div>
            <div class="price"  data-price>$/ay</div>
            <div class="quota"  data-quota>Kota</div>
          </div>
          <div class="plan" data-plan="pro"   data-monthly-price="19" data-yearly-price="190" data-monthly-quota="500"  data-yearly-quota="6000">
            <div class="planTitle">Pro</div>
            <div class="price"  data-price>$/ay</div>
            <div class="quota"  data-quota>Kota</div>
          </div>
          <div class="plan" data-plan="max"   data-monthly-price="49" data-yearly-price="490" data-monthly-quota="1500" data-yearly-quota="18000">
            <div class="planTitle">Max</div>
            <div class="price"  data-price>$/ay</div>
            <div class="quota"  data-quota>Kota</div>
          </div>
        </div>
      </div>

      <!-- SAĞ: Özet & Ödeme -->
      <div class="card">
        <h3 class="secTitle">Sipariş Özeti</h3>
        <div class="summaryRow"><div>Plan</div><div id="summaryPlan" class="muted">Seçiniz</div></div>
        <div class="summaryRow"><div>Süre</div><div id="summaryDuration" class="muted">1 Ay</div></div>
        <div class="summaryRow"><div>Kota</div><div id="summaryQuota" class="muted">-</div></div>
        <div class="summaryRow"><div>Toplam</div><div id="summaryTotal" class="muted">$0.00</div></div>

        <button id="payButton" class="cta" disabled>
          <span id="payButtonText">Plan Seçin</span>
        </button>

        <div id="iframeWrap" class="iframeWrap">
          <iframe id="paytrFrame" title="Ödeme"></iframe>
        </div>

        <div id="statusMsg" class="muted" style="margin-top:10px"></div>
      </div>
    </div>

    <div class="foot">Herhangi bir sorunda bize WhatsApp’tan ulaşın.</div>
  </div>

  <script>
    // ====== Supabase (sadece okuma için anon key) ======
    const SUPABASE_URL = 'https://dblepmaqqkudsbmvlqcw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRibGVwbWFxcWt1ZHNibXZscWN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0NTUzOTksImV4cCI6MjA3MjAzMTM5OX0.yOPbSl2o2LjHNryW0eIfKeJa5YJgBC94GWzswlclPWg';

    // ====== Durum / Seçimler ======
    let selectedPlan = null;          // 'basic' | 'pro' | 'max'
    let selectedBilling = 'monthly';  // 'monthly' | 'yearly'
    let currentUser = null;           // Supabase’ten gelen satır

    // DOM yardımcı
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    // URL parametrelerini oku
    const params = new URLSearchParams(location.search);
    const urlPref = {
      phone:   params.get('phone') || '',
      plan:    (params.get('plan') || '').toLowerCase(),
      billing: (params.get('billing') || '').toLowerCase()
    };

    function formatMoney(n){ return '$' + Number(n||0).toFixed(2); }
    function normalizePhone(v){ return (v||'').replace(/[^\d+]/g,''); }

    // Plan kartlarını fiyata göre güncelle
    function paintPlanCards(){
      const yearly = selectedBilling === 'yearly';
      $$('#plans .plan').forEach(card=>{
        const mp = Number(card.dataset.monthlyPrice);
        const yp = Number(card.dataset.yearlyPrice);
        const mq = Number(card.dataset.monthlyQuota);
        const yq = Number(card.dataset.yearlyQuota);
        const price = yearly ? yp : mp;
        const quota = yearly ? yq : mq;
        card.querySelector('[data-price]').textContent = yearly ? `$${yp} /yıl` : `$${mp} /ay`;
        card.querySelector('[data-quota]').textContent = (quota||0).toLocaleString('tr-TR') + ' mesaj';
      });
    }

    function updateSummary(){
      const yearly = selectedBilling === 'yearly';
      $('#summaryDuration').textContent = yearly ? '1 Yıl' : '1 Ay';

      if(!selectedPlan){
        $('#summaryPlan').textContent   = 'Seçiniz';
        $('#summaryQuota').textContent  = '-';
        $('#summaryTotal').textContent  = '$0.00';
        $('#payButton').disabled = true;
        $('#payButtonText').textContent = 'Plan Seçin';
        return;
      }
      const card = $(`.plan[data-plan="${selectedPlan}"]`);
      const price = Number(card.dataset[ yearly ? 'yearlyPrice':'monthlyPrice' ]);
      const quota = Number(card.dataset[ yearly ? 'yearlyQuota':'monthlyQuota' ]);
      $('#summaryPlan').textContent  = card.querySelector('.planTitle').textContent.trim();
      $('#summaryQuota').textContent = quota.toLocaleString('tr-TR') + ' mesaj';
      $('#summaryTotal').textContent = formatMoney(price);
      $('#payButton').disabled = false;
      $('#payButtonText').textContent = formatMoney(price) + ' Öde';
    }

    function selectPlan(plan){
      selectedPlan = plan;
      $$('#plans .plan').forEach(c => c.dataset.selected = (c.dataset.plan === plan ? 'true':'false'));
      updateSummary();
    }

    function setBilling(mode){ // 'monthly' | 'yearly'
      selectedBilling = mode;
      $('#billingSwitch').dataset.mode = mode;
      paintPlanCards();
      updateSummary();
    }

    // Kullanıcıyı Supabase’ten getir
    async function fetchUserByPhone(phone){
      const clean = normalizePhone(phone);
      if(!clean) return null;
      const url = `${SUPABASE_URL}/rest/v1/customers?contact_phone=eq.${encodeURIComponent(clean)}&select=*`;
      const res = await fetch(url, { headers:{ apikey:SUPABASE_ANON_KEY, Authorization:`Bearer ${SUPABASE_ANON_KEY}` }});
      const data = await res.json();
      return data && data[0] ? data[0] : null;
    }

    // PASSIVE uyarısını göster/gizle
    function showPassiveBanner(visible){
      const el = $('#passiveBanner');
      if(visible) el.classList.add('show'); else el.classList.remove('show');
    }

    // Açılış: URL varsayılanlarını uygula + kullanıcı çek
    async function bootstrap(){
      // URL’den gelen prefilleri uygula
      if(urlPref.billing === 'yearly' || urlPref.billing === 'monthly') setBilling(urlPref.billing);
      else setBilling('monthly');

      paintPlanCards();

      if(urlPref.plan && ['basic','pro','max'].includes(urlPref.plan)) selectPlan(urlPref.plan);

      if(urlPref.phone){
        $('#phone').value = urlPref.phone;
        currentUser = await fetchUserByPhone(urlPref.phone);
      }

      // Supabase’ten geldiyse formu doldur
      if(currentUser){
        if(currentUser.name)    $('#fullName').value = currentUser.name;
        if(currentUser.company_name) $('#company').value = currentUser.company_name;

        // Durum değerlendirmesi
        const now = new Date();
        const trialEnd = currentUser.trial_end_date ? new Date(currentUser.trial_end_date) : null;
        const planEnd  = currentUser.plan_end_date  ? new Date(currentUser.plan_end_date)  : null;
        let status = (currentUser.subscription_status||'').toLowerCase();
        if(status === 'trial' && trialEnd && trialEnd < now) status = 'passive';
        if(status === 'active' && planEnd  && planEnd  < now) status = 'passive';
        if(currentUser.used_quota >= (currentUser.monthly_quota||0)) status = 'passive';

        showPassiveBanner(status === 'passive');
      }

      updateSummary();
    }

    // Plan kartı tıklamaları
    $$('#plans .plan').forEach(card=>{
      card.addEventListener('click', ()=> selectPlan(card.dataset.plan));
    });

    // Faturalama toggle
    $('#billingSwitch').addEventListener('click', ()=>{
      setBilling( selectedBilling === 'monthly' ? 'yearly' : 'monthly' );
    });

    // ÖDEME AKIŞI
    async function createPayment(payload){
      // Backend’inde karşılığı: POST /api/payment/create
      // Expected response:
      // 1) { redirect_url: "https://..." }  --> direkt yönlendir
      //   veya
      // 2) { token: "...", order_id: "..." } --> PayTR iframe + /api/payment/status/:id poll
      const res = await fetch('/api/payment/create', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      if(!res.ok) throw new Error('Ödeme başlatılamadı');
      return res.json();
    }

    async function pollStatus(orderId){
      // Backend: GET /api/payment/status/{orderId} -> { status: 'pending'|'completed'|'failed' }
      $('#statusMsg').textContent = 'Ödeme durumu kontrol ediliyor...';
      for(let i=0;i<60;i++){ // ~60 sn
        await new Promise(r=>setTimeout(r, 1000));
        const r = await fetch(`/api/payment/status/${encodeURIComponent(orderId)}`, { cache:'no-store' });
        if(!r.ok) continue;
        const data = await r.json();
        if(data.status === 'completed'){
          $('#statusMsg').textContent = 'Ödeme tamamlandı. Aboneliğiniz güncelleniyor...';
          return 'completed';
        }
        if(data.status === 'failed'){
          $('#statusMsg').textContent = 'Ödeme başarısız oldu, lütfen tekrar deneyin.';
          return 'failed';
        }
      }
      $('#statusMsg').textContent = 'Süre doldu, durum kesinleşmedi. Hesabınızda son durumu kontrol edin.';
      return 'timeout';
    }

    function openIframe(token){
      const url = `https://www.paytr.com/odeme/iframe/${encodeURIComponent(token)}`;
      $('#iframeWrap').style.display = 'block';
      $('#paytrFrame').src = url;
      window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth' });
    }

    // Öde butonu
    $('#payButton').addEventListener('click', async ()=>{
      const name    = $('#fullName').value.trim();
      const company = $('#company').value.trim();
      const phone   = normalizePhone($('#phone').value);

      if(!name || !company || !phone){ alert('Ad Soyad, Şirket ve Telefon gereklidir.'); return; }
      if(!selectedPlan){ alert('Lütfen bir plan seçin.'); return; }

      const yearly = selectedBilling === 'yearly';
      const card   = $(`.plan[data-plan="${selectedPlan}"]`);
      const price  = Number(card.dataset[ yearly ? 'yearlyPrice':'monthlyPrice' ]);
      const quota  = Number(card.dataset[ yearly ? 'yearlyQuota':'monthlyQuota' ]);

      $('#payButton').disabled = true;
      $('#payButtonText').textContent = 'Hazırlanıyor...';

      const payload = {
        name, company, phone,
        plan: selectedPlan,
        billing: selectedBilling,
        price, quota,
        // status kullanımında backend: ACTIVE ise uzatma, PASSIVE ise başlatma yapar.
        context_status: (currentUser?.subscription_status || '').toLowerCase()
      };

      try{
        const r = await createPayment(payload);

        // Yol 1: redirect_url
        if(r.redirect_url){
          location.href = r.redirect_url;
          return;
        }

        // Yol 2: token + order_id -> iframe + polling
        if(r.token && r.order_id){
          $('#statusMsg').textContent = 'Güvenli ödeme sayfası yükleniyor...';
          openIframe(r.token);
          const result = await pollStatus(r.order_id);
          if(result === 'completed'){
            // Başarılı -> success.html’e taşı
            const q = new URLSearchParams({
              phone, plan:selectedPlan, billing:selectedBilling, payment:'success'
            }).toString();
            location.href = '/success.html?' + q;
            return;
          }
        }

        // Beklenmeyen cevap
        $('#payButton').disabled = false;
        $('#payButtonText').textContent = formatMoney(price) + ' Öde';
        alert('Ödeme başlatma yanıtı beklenen formatta değil.');

      }catch(err){
        console.error(err);
        $('#payButton').disabled = false;
        $('#payButtonText').textContent = formatMoney(price) + ' Öde';
        alert('Ödeme başlatılırken hata oluştu. Lütfen tekrar deneyin.');
      }
    });

    // Açılış
    window.addEventListener('DOMContentLoaded', bootstrap);
  </script>
</body>
</html>
