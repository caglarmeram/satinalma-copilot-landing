<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Satƒ±nalma CoPilot ‚Äî √ñdeme</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <!-- Stripe JS -->
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    :root { --bg:#0b1220; --card:#101a2f; --muted:#93a4bf; --text:#e9eef8; --primary:#4f8cff; --ok:#19c37d; --warn:#f6a609; --danger:#ff6b6b; }
    * { box-sizing:border-box }
    body { margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:linear-gradient(160deg,#0b1220,#0d1325,#0a0f1c); color:var(--text); }
    .wrap { max-width:1100px; margin:0 auto; padding:24px; }
    .header { display:flex; align-items:center; gap:12px; }
    .logo { width:44px; height:44px; border-radius:12px; background:#121d35; display:grid; place-items:center; font-weight:800; color:#9cc0ff; }
    h1 { font-size:26px; margin:10px 0 2px }
    .muted { color:var(--muted); font-size:14px }
    .grid { margin-top:24px; display:grid; grid-template-columns: 1.2fr 1fr; gap:20px }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr; } }
    .card { background:linear-gradient(180deg,#0f1930,#0d172b); border:1px solid #1f2a44; border-radius:16px; padding:18px; box-shadow:0 8px 30px rgba(0,0,0,.25) }
    .secTitle { font-weight:700; font-size:16px; margin:0 0 10px }
    label { display:block; font-size:13px; color:var(--muted); margin:10px 0 6px }
    input,select { width:100%; background:#0b1326; border:1px solid #1e2b48; color:var(--text); padding:10px 12px; border-radius:10px; outline:none }
    input:focus { border-color:#355aa5; box-shadow:0 0 0 2px rgba(79,140,255,.15) }
    .plans { display:grid; grid-template-columns: repeat(3,1fr); gap:12px; margin-top:10px }
    @media (max-width:900px){ .plans { grid-template-columns:1fr } }
    .plan { border:1px solid #1f2a44; border-radius:14px; padding:14px; background:#0f1830; cursor:pointer; position:relative; }
    .plan[data-selected="true"] { outline:2px solid var(--primary); box-shadow:0 0 0 4px rgba(79,140,255,.15) inset; }
    .planTitle { font-weight:700; }
    .price { font-size:22px; font-weight:800; margin-top:6px }
    .quota { font-size:12px; color:#a9b7d3; }
    .billToggle { display:flex; gap:8px; align-items:center; margin-top:8px; }
    .switch { position:relative; width:56px; height:30px; background:#172242; border-radius:999px; border:1px solid #24335a; cursor:pointer }
    .switch::after { content:""; position:absolute; top:3px; left:3px; width:24px; height:24px; background:#eaf1ff; border-radius:50%; transition:.2s }
    .switch[data-mode="yearly"]::after { left:29px }
    .badge { font-size:11px; padding:3px 8px; border-radius:999px; background:#13224a; color:#9fc2ff; border:1px solid #2a3f76 }
    .summaryRow { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #1f2a44; }
    .summaryRow:last-child { border-bottom:0 }
    .cta { width:100%; margin-top:14px; padding:14px 16px; font-weight:800; border-radius:12px; border:0; background:linear-gradient(135deg,#568dff,#3a6ee8); color:white; cursor:pointer }
    .cta[disabled] { opacity:.6; cursor:not-allowed }
    .banner { display:none; border:1px solid #3a2a1a; background:linear-gradient(180deg,#2a1b10,#23160e); color:#ffd9a8; padding:12px; border-radius:10px; margin:10px 0 }
    .banner.show { display:block }
    .ok { color:var(--ok) } .warn { color:var(--warn) } .danger { color:var(--danger) }
    .foot { margin-top:30px; font-size:12px; color:#7f8fb1; text-align:center }
    
    /* NEW: Stripe Elements styling */
    .stripe-elements {
      margin-top: 20px;
      padding: 16px;
      background: #0b1326;
      border: 1px solid #1e2b48;
      border-radius: 12px;
    }
    
    .payment-methods {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin: 12px 0;
    }
    
    .payment-method {
      padding: 8px 12px;
      background: #0f1830;
      border: 1px solid #1f2a44;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    
    .payment-method:hover {
      border-color: var(--primary);
    }
    
    .payment-method.selected {
      border-color: var(--primary);
      background: rgba(79, 140, 255, 0.1);
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(11, 18, 32, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    .loading-content {
      background: var(--card);
      padding: 40px;
      border-radius: 16px;
      text-align: center;
      border: 1px solid #1f2a44;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #1e2b48;
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <h3 id="loadingText">ƒ∞≈üleniyor...</h3>
      <p>L√ºtfen bekleyin</p>
    </div>
  </div>

  <div class="wrap">
    <div class="header">
      <div class="logo">SC</div>
      <div>
        <h1>√ñdeme ve Plan Se√ßimi</h1>
        <div class="muted">Denemeniz bittiyse aboneliƒüinizi ba≈ülatƒ±n; aktifsiniz ve devam etmek istiyorsanƒ±z s√ºrenizi uzatƒ±n ya da kota ekleyin.</div>
      </div>
    </div>

    <!-- PASSIVE/EXPIRED uyarƒ± bandƒ± -->
    <div id="passiveBanner" class="banner">Hesabƒ±nƒ±z <b>PASSIVE</b> durumda. Devam etmek i√ßin bir plan se√ßerek √∂demeyi tamamlayƒ±n.</div>

    <div class="grid">
      <!-- SOL: Kullanƒ±cƒ± & Plan -->
      <div class="card">
        <h3 class="secTitle">Bilgileriniz</h3>
        <label>Ad Soyad</label>
        <input id="fullName" placeholder="Ad Soyad" autocomplete="name" />
        <label>≈ûirket</label>
        <input id="company" placeholder="≈ûirket" autocomplete="organization" />
        <label>Telefon (WhatsApp)</label>
        <input id="phone" placeholder="+90..." autocomplete="tel" />

        <h3 class="secTitle" style="margin-top:14px">Fatura D√∂nemi</h3>
        <div class="billToggle">
          <span>Aylƒ±k</span>
          <div id="billingSwitch" class="switch" data-mode="monthly" role="switch" aria-label="Faturalama D√∂nemi"></div>
          <span>Yƒ±llƒ±k <span class="badge">%50 ƒ∞ndirim</span></span>
        </div>

        <h3 class="secTitle" style="margin-top:14px">Plan Se√ß</h3>
        <div id="plans" class="plans">
          <!-- Updated pricing to match new structure -->
          <div class="plan" data-plan="basic" data-monthly-price="9.95"  data-yearly-price="4.95"  data-monthly-quota="500"  data-yearly-quota="6000">
            <div class="planTitle">Basic</div>
            <div class="price" data-price>$/ay</div>
            <div class="quota" data-quota>Kota</div>
          </div>
          <div class="plan" data-plan="pro"   data-monthly-price="24.95" data-yearly-price="12.95" data-monthly-quota="1500"  data-yearly-quota="18000">
            <div class="planTitle">Pro</div>
            <div class="price" data-price>$/ay</div>
            <div class="quota" data-quota>Kota</div>
          </div>
          <div class="plan" data-plan="max"   data-monthly-price="49.95" data-yearly-price="29.95" data-monthly-quota="5000" data-yearly-quota="60000">
            <div class="planTitle">Max</div>
            <div class="price" data-price>$/ay</div>
            <div class="quota" data-quota>Kota</div>
          </div>
        </div>
      </div>

      <!-- SAƒû: √ñzet & √ñdeme -->
      <div class="card">
        <h3 class="secTitle">Sipari≈ü √ñzeti</h3>
        <div class="summaryRow"><div>Plan</div><div id="summaryPlan" class="muted">Se√ßiniz</div></div>
        <div class="summaryRow"><div>S√ºre</div><div id="summaryDuration" class="muted">1 Ay</div></div>
        <div class="summaryRow"><div>Kota</div><div id="summaryQuota" class="muted">-</div></div>
        <div class="summaryRow"><div>Toplam</div><div id="summaryTotal" class="muted">$0.00</div></div>

        <button id="payButton" class="cta" disabled>
          <span id="payButtonText">Plan Se√ßin</span>
        </button>

        <div id="statusMsg" class="muted" style="margin-top:10px"></div>
        
        <div style="margin-top: 20px; padding: 12px; background: rgba(25, 195, 125, 0.1); border: 1px solid rgba(25, 195, 125, 0.2); border-radius: 8px; font-size: 12px; color: #19c37d;">
          <div><strong>üí≥ Global √ñdeme:</strong> Stripe g√ºvenli √∂deme</div>
          <div><strong>üåç Para Birimi:</strong> USD g√∂sterilir, kartƒ±nƒ±za local currency yansƒ±r</div>
          <div><strong>üõ°Ô∏è G√ºvenlik:</strong> SSL ≈üifreli, PCI DSS uyumlu</div>
        </div>
      </div>
    </div>

    <div class="foot">Herhangi bir sorunda bize WhatsApp'tan ula≈üƒ±n.</div>
  </div>

  <script>
    // ====== Stripe Configuration ======
    const STRIPE_PUBLISHABLE_KEY = 'pk_live_51QjKBSB...'; // Replace with actual live key
    let stripe = null;
    
    // ====== API Configuration ======
    const API_BASE_URL = 'https://api.satinalmacopilot.com';
    const SUPABASE_URL = 'https://dblepmaqqkudsbmvlqcw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRibGVwbWFxcWt1ZHNibXZscWN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0NTUzOTksImV4cCI6MjA3MjAzMTM5OX0.yOPbSl2o2LjHNryW0eIfKeJa5YJgBC94GWzswlclPWg';

    // ====== State Variables ======
    let selectedPlan = null;          // 'basic' | 'pro' | 'max'
    let selectedBilling = 'monthly';  // 'monthly' | 'yearly'
    let currentUser = null;           // Supabase'ten gelen satƒ±r

    // DOM helper
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    // URL parametrelerini oku
    const params = new URLSearchParams(location.search);
    const urlPref = {
      phone:   params.get('phone') || '',
      plan:    (params.get('plan') || '').toLowerCase(),
      billing: (params.get('billing') || '').toLowerCase(),
      return_user: params.get('return_user') === 'true',
      reason: params.get('reason') || ''
    };

    function formatMoney(n){ return '$' + Number(n||0).toFixed(2); }
    function normalizePhone(v){ return (v||'').replace(/[^\d+]/g,''); }

    function showLoading(message = 'ƒ∞≈üleniyor...') {
      $('#loadingText').textContent = message;
      $('#loadingOverlay').style.display = 'flex';
    }

    function hideLoading() {
      $('#loadingOverlay').style.display = 'none';
    }

    // Plan kartlarƒ±nƒ± fiyata g√∂re g√ºncelle
    function paintPlanCards(){
      const yearly = selectedBilling === 'yearly';
      $$('#plans .plan').forEach(card=>{
        const mp = Number(card.dataset.monthlyPrice);
        const yp = Number(card.dataset.yearlyPrice);
        const mq = Number(card.dataset.monthlyQuota);
        const yq = Number(card.dataset.yearlyQuota);
        const price = yearly ? yp : mp;
        const quota = yearly ? yq : mq;
        
        // Updated display format
        if (yearly) {
          card.querySelector('[data-price]').textContent = `$${yp}/ay`;
          const savings = ((mp * 12 - yp * 12) / (mp * 12) * 100).toFixed(0);
          card.querySelector('[data-quota]').textContent = `${quota.toLocaleString('tr-TR')} mesaj (${savings}% tasarruf)`;
        } else {
          card.querySelector('[data-price]').textContent = `$${mp}/ay`;
          card.querySelector('[data-quota]').textContent = `${quota.toLocaleString('tr-TR')} mesaj`;
        }
      });
    }

    function updateSummary(){
      const yearly = selectedBilling === 'yearly';
      $('#summaryDuration').textContent = yearly ? '1 Yƒ±l (aylƒ±k faturalama)' : '1 Ay';

      if(!selectedPlan){
        $('#summaryPlan').textContent   = 'Se√ßiniz';
        $('#summaryQuota').textContent  = '-';
        $('#summaryTotal').textContent  = '$0.00';
        $('#payButton').disabled = true;
        $('#payButtonText').textContent = 'Plan Se√ßin';
        return;
      }
      
      const card = $(`.plan[data-plan="${selectedPlan}"]`);
      const price = Number(card.dataset[ yearly ? 'yearlyPrice':'monthlyPrice' ]);
      const quota = Number(card.dataset[ yearly ? 'yearlyQuota':'monthlyQuota' ]);
      
      $('#summaryPlan').textContent  = card.querySelector('.planTitle').textContent.trim();
      $('#summaryQuota').textContent = quota.toLocaleString('tr-TR') + ' mesaj';
      
      if (yearly) {
        $('#summaryTotal').textContent = `${formatMoney(price)}/ay (yƒ±llƒ±k ${formatMoney(price * 12)})`;
      } else {
        $('#summaryTotal').textContent = formatMoney(price);
      }
      
      $('#payButton').disabled = false;
      $('#payButtonText').textContent = yearly ? `${formatMoney(price * 12)} √ñde (Yƒ±llƒ±k)` : `${formatMoney(price)} √ñde`;
    }

    function selectPlan(plan){
      selectedPlan = plan;
      $$('#plans .plan').forEach(c => c.dataset.selected = (c.dataset.plan === plan ? 'true':'false'));
      updateSummary();
    }

    function setBilling(mode){ // 'monthly' | 'yearly'
      selectedBilling = mode;
      $('#billingSwitch').dataset.mode = mode;
      paintPlanCards();
      updateSummary();
    }

    // Kullanƒ±cƒ±yƒ± Supabase'ten getir
    async function fetchUserByPhone(phone){
      const clean = normalizePhone(phone);
      if(!clean) return null;
      const url = `${SUPABASE_URL}/rest/v1/customers?contact_phone=eq.${encodeURIComponent(clean)}&select=*`;
      const res = await fetch(url, { headers:{ apikey:SUPABASE_ANON_KEY, Authorization:`Bearer ${SUPABASE_ANON_KEY}` }});
      const data = await res.json();
      return data && data[0] ? data[0] : null;
    }

    // PASSIVE uyarƒ±sƒ±nƒ± g√∂ster/gizle
    function showPassiveBanner(visible){
      const el = $('#passiveBanner');
      if(visible) el.classList.add('show'); else el.classList.remove('show');
    }

    // A√ßƒ±lƒ±≈ü: URL varsayƒ±lanlarƒ±nƒ± uygula + kullanƒ±cƒ± √ßek
    async function bootstrap(){
      // Initialize Stripe
      if (window.Stripe && STRIPE_PUBLISHABLE_KEY) {
        stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
      }

      // URL'den gelen prefilleri uygula
      if(urlPref.billing === 'yearly' || urlPref.billing === 'monthly') setBilling(urlPref.billing);
      else setBilling('yearly'); // Default to yearly for better pricing

      paintPlanCards();

      if(urlPref.plan && ['basic','pro','max'].includes(urlPref.plan)) selectPlan(urlPref.plan);
      else selectPlan('pro'); // Default to pro plan

      if(urlPref.phone){
        $('#phone').value = urlPref.phone;
        currentUser = await fetchUserByPhone(urlPref.phone);
      }

      // Supabase'ten geldiyse formu doldur
      if(currentUser){
        if(currentUser.name)    $('#fullName').value = currentUser.name;
        if(currentUser.company_name) $('#company').value = currentUser.company_name;

        // Durum deƒüerlendirmesi
        const now = new Date();
        const trialEnd = currentUser.trial_end_date ? new Date(currentUser.trial_end_date) : null;
        const planEnd  = currentUser.plan_end_date  ? new Date(currentUser.plan_end_date)  : null;
        let status = (currentUser.subscription_status||'').toLowerCase();
        if(status === 'trial' && trialEnd && trialEnd < now) status = 'passive';
        if(status === 'active' && planEnd  && planEnd  < now) status = 'passive';
        if(currentUser.used_quota >= (currentUser.monthly_quota||0)) status = 'passive';

        showPassiveBanner(status === 'passive');
        
        // Show personalized message for returning users
        if (urlPref.return_user) {
          let message = '';
          switch(urlPref.reason) {
            case 'trial_expired':
              message = 'Trial s√ºreniz sona erdi. Devam etmek i√ßin bir plan se√ßin.';
              break;
            case 'quota_exceeded':
              message = 'Mesaj kotanƒ±z doldu. Plan y√ºkseltin veya yenileyin.';
              break;
            default:
              message = 'Hesabƒ±nƒ±zƒ± yeniden aktifle≈ütirmek i√ßin bir plan se√ßin.';
          }
          $('#statusMsg').textContent = message;
          $('#statusMsg').style.color = '#f6a609';
        }
      }

      updateSummary();
    }

    // Plan kartƒ± tƒ±klamalarƒ±
    $$('#plans .plan').forEach(card=>{
      card.addEventListener('click', ()=> selectPlan(card.dataset.plan));
    });

    // Faturalama toggle
    $('#billingSwitch').addEventListener('click', ()=>{
      setBilling( selectedBilling === 'monthly' ? 'yearly' : 'monthly' );
    });

    // NEW: Stripe Checkout Integration
    async function createStripeCheckout(payload){
      try {
        const response = await fetch(`${API_BASE_URL}/api/create-checkout-session`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error('Checkout session olu≈üturulamadƒ±');
        }

        const session = await response.json();
        return session;
      } catch (error) {
        console.error('Stripe checkout error:', error);
        throw error;
      }
    }

    // √ñde butonu
    $('#payButton').addEventListener('click', async ()=>{
      const name    = $('#fullName').value.trim();
      const company = $('#company').value.trim();
      const phone   = normalizePhone($('#phone').value);

      if(!name || !company || !phone){ 
        alert('Ad Soyad, ≈ûirket ve Telefon gereklidir.'); 
        return; 
      }
      if(!selectedPlan){ 
        alert('L√ºtfen bir plan se√ßin.'); 
        return; 
      }

      const yearly = selectedBilling === 'yearly';
      const card   = $(`.plan[data-plan="${selectedPlan}"]`);
      const monthlyPrice = Number(card.dataset.monthlyPrice);
      const yearlyPrice = Number(card.dataset.yearlyPrice);
      const price  = yearly ? yearlyPrice : monthlyPrice;
      const quota  = Number(card.dataset[ yearly ? 'yearlyQuota':'monthlyQuota' ]);

      $('#payButton').disabled = true;
      $('#payButtonText').textContent = 'Hazƒ±rlanƒ±yor...';
      showLoading('G√ºvenli √∂deme sayfasƒ± hazƒ±rlanƒ±yor...');

      const payload = {
        customer: {
          name, 
          company, 
          phone,
          email: currentUser?.email || `${phone.replace(/[^\d]/g, '')}@temp.com`
        },
        plan: selectedPlan,
        billing: selectedBilling,
        price: yearly ? yearlyPrice * 12 : monthlyPrice, // Total amount
        monthlyPrice: yearly ? yearlyPrice : monthlyPrice,
        quota,
        context: currentUser?.subscription_status || 'new',
        success_url: `${window.location.origin}/success.html?session_id={CHECKOUT_SESSION_ID}`,
        cancel_url: `${window.location.origin}/payment.html?phone=${encodeURIComponent(phone)}&plan=${selectedPlan}&billing=${selectedBilling}`
      };

      try {
        const session = await createStripeCheckout(payload);
        hideLoading();

        if (session.sessionId) {
          $('#statusMsg').textContent = 'Stripe √∂deme sayfasƒ±na y√∂nlendiriliyorsunuz...';
          
          // Redirect to Stripe Checkout
          const { error } = await stripe.redirectToCheckout({
            sessionId: session.sessionId
          });

          if (error) {
            console.error('Stripe redirect error:', error);
            throw new Error('√ñdeme sayfasƒ±na y√∂nlendirilemedi');
          }
        } else {
          throw new Error('Checkout session olu≈üturulamadƒ±');
        }

      } catch(err) {
        console.error('Payment error:', err);
        hideLoading();
        $('#payButton').disabled = false;
        $('#payButtonText').textContent = yearly ? `${formatMoney(yearlyPrice * 12)} √ñde (Yƒ±llƒ±k)` : `${formatMoney(monthlyPrice)} √ñde`;
        $('#statusMsg').textContent = '√ñdeme ba≈ülatƒ±lƒ±rken hata olu≈ütu. L√ºtfen tekrar deneyin.';
        $('#statusMsg').style.color = '#ff6b6b';
        
        alert(`√ñdeme i≈ülemi ba≈ülatƒ±lamadƒ±: ${err.message}\n\nDestek: info@satinalmacopilot.com`);
      }
    });

    // A√ßƒ±lƒ±≈ü
    window.addEventListener('DOMContentLoaded', bootstrap);
  </script>
</body>
</html>
