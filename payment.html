<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Satƒ±nalma CoPilot ‚Äì √ñdeme</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    :root { --bg:#0b1220; --card:#101a2f; --muted:#93a4bf; --text:#e9eef8; --primary:#4f8cff; --ok:#19c37d; --warn:#f6a609; --danger:#ff6b6b; }
    * { box-sizing:border-box; margin:0; padding:0 }
    body { font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:linear-gradient(160deg,#0b1220,#0d1325,#0a0f1c); color:var(--text); }
    .wrap { max-width:1100px; margin:0 auto; padding:24px; }
    .header { display:flex; align-items:center; gap:12px; margin-bottom:20px }
    .logo { width:44px; height:44px; border-radius:12px; background:#121d35; display:grid; place-items:center; font-weight:800; color:#9cc0ff; font-size:20px }
    h1 { font-size:26px; margin:10px 0 2px }
    .muted { color:var(--muted); font-size:14px }
    .grid { margin-top:24px; display:grid; grid-template-columns:1.2fr 1fr; gap:20px }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr } }
    .card { background:linear-gradient(180deg,#0f1930,#0d172b); border:1px solid #1f2a44; border-radius:16px; padding:18px; box-shadow:0 8px 30px rgba(0,0,0,.25) }
    .secTitle { font-weight:700; font-size:16px; margin:16px 0 10px }
    .secTitle:first-child { margin-top:0 }
    label { display:block; font-size:13px; color:var(--muted); margin:10px 0 6px }
    input,select { width:100%; background:#0b1326; border:1px solid #1e2b48; color:var(--text); padding:10px 12px; border-radius:10px; outline:none; font-size:14px }
    input:focus { border-color:#355aa5; box-shadow:0 0 0 2px rgba(79,140,255,.15) }
    .plans { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-top:10px }
    @media (max-width:900px){ .plans { grid-template-columns:1fr } }
    .plan { border:1px solid #1f2a44; border-radius:14px; padding:14px; background:#0f1830; cursor:pointer; position:relative; transition:all .2s }
    .plan:hover { border-color:#355aa5 }
    .plan[data-selected="true"] { outline:2px solid var(--primary); box-shadow:0 0 0 4px rgba(79,140,255,.15) inset }
    .planTitle { font-weight:700; font-size:15px }
    .price { font-size:22px; font-weight:800; margin-top:6px; color:#9cc0ff }
    .quota { font-size:12px; color:#a9b7d3; margin-top:4px }
    .billToggle { display:flex; gap:8px; align-items:center; margin-top:8px }
    .switch { position:relative; width:56px; height:30px; background:#172242; border-radius:999px; border:1px solid #24335a; cursor:pointer; transition:.3s }
    .switch::after { content:""; position:absolute; top:3px; left:3px; width:24px; height:24px; background:#eaf1ff; border-radius:50%; transition:.2s }
    .switch[data-mode="yearly"]::after { left:29px }
    .badge { font-size:11px; padding:3px 8px; border-radius:999px; background:#13224a; color:#9fc2ff; border:1px solid #2a3f76; font-weight:600 }
    .summaryRow { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #1f2a44; font-size:14px }
    .summaryRow:last-child { border-bottom:0; font-weight:700; font-size:16px; color:#9cc0ff }
    .cta { width:100%; margin-top:14px; padding:14px 16px; font-weight:800; border-radius:12px; border:0; background:linear-gradient(135deg,#568dff,#3a6ee8); color:white; cursor:pointer; font-size:15px; transition:all .3s }
    .cta:hover:not([disabled]) { transform:translateY(-2px); box-shadow:0 8px 20px rgba(79,140,255,.4) }
    .cta[disabled] { opacity:.6; cursor:not-allowed }
    .banner { display:none; border:1px solid #3a2a1a; background:linear-gradient(180deg,#2a1b10,#23160e); color:#ffd9a8; padding:12px; border-radius:10px; margin:10px 0; font-size:14px }
    .banner.show { display:block }
    .foot { margin-top:30px; font-size:12px; color:#7f8fb1; text-align:center }
    .loading-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(11,18,32,.9); display:none; align-items:center; justify-content:center; z-index:9999 }
    .loading-content { background:var(--card); padding:40px; border-radius:16px; text-align:center; border:1px solid #1f2a44 }
    .spinner { width:40px; height:40px; border:3px solid #1e2b48; border-top:3px solid var(--primary); border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 20px }
    @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
    .info-box { margin-top:20px; padding:12px; background:rgba(25,195,125,.1); border:1px solid rgba(25,195,125,.2); border-radius:8px; font-size:12px; color:#19c37d; line-height:1.6 }
    .info-box strong { color:#19c37d }
    #statusMsg { margin-top:10px; font-size:13px; min-height:20px }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <h3 id="loadingText">ƒ∞≈üleniyor...</h3>
      <p style="color:var(--muted); margin-top:8px">L√ºtfen bekleyin</p>
    </div>
  </div>

  <div class="wrap">
    <div class="header">
      <div class="logo">SC</div>
      <div>
        <h1>√ñdeme ve Plan Se√ßimi</h1>
        <div class="muted">Denemeniz bittiyse aboneliƒüinizi ba≈ülatƒ±n; aktifsiniz ve devam etmek istiyorsanƒ±z s√ºrenizi uzatƒ±n ya da kota ekleyin.</div>
      </div>
    </div>

    <div id="passiveBanner" class="banner">Hesabƒ±nƒ±z <b>PASSIVE</b> durumda. Devam etmek i√ßin bir plan se√ßerek √∂demeyi tamamlayƒ±n.</div>

    <div class="grid">
      <div class="card">
        <h3 class="secTitle">Bilgileriniz</h3>
        <label>Ad Soyad</label>
        <input id="fullName" placeholder="Ad Soyad" autocomplete="name" />
        <label>≈ûirket</label>
        <input id="company" placeholder="≈ûirket" autocomplete="organization" />
        <label>Telefon (WhatsApp)</label>
        <input id="phone" placeholder="+90..." autocomplete="tel" />

        <h3 class="secTitle">Fatura D√∂nemi</h3>
        <div class="billToggle">
          <span>Aylƒ±k</span>
          <div id="billingSwitch" class="switch" data-mode="monthly" role="switch" aria-label="Faturalama D√∂nemi"></div>
          <span>Yƒ±llƒ±k <span class="badge">%50 ƒ∞ndirim</span></span>
        </div>

        <h3 class="secTitle">Plan Se√ß</h3>
        <div id="plans" class="plans">
          <div class="plan" data-plan="basic" data-monthly-price="9.95" data-yearly-price="4.95" data-monthly-quota="500" data-yearly-quota="6000">
            <div class="planTitle">Basic</div>
            <div class="price" data-price>$/ay</div>
            <div class="quota" data-quota>Kota</div>
          </div>
          <div class="plan" data-plan="pro" data-monthly-price="24.95" data-yearly-price="12.95" data-monthly-quota="1500" data-yearly-quota="18000">
            <div class="planTitle">Pro</div>
            <div class="price" data-price>$/ay</div>
            <div class="quota" data-quota>Kota</div>
          </div>
          <div class="plan" data-plan="max" data-monthly-price="49.95" data-yearly-price="29.95" data-monthly-quota="5000" data-yearly-quota="60000">
            <div class="planTitle">Max</div>
            <div class="price" data-price>$/ay</div>
            <div class="quota" data-quota>Kota</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 class="secTitle">Sipari≈ü √ñzeti</h3>
        <div class="summaryRow"><div>Plan</div><div id="summaryPlan" class="muted">Se√ßiniz</div></div>
        <div class="summaryRow"><div>S√ºre</div><div id="summaryDuration" class="muted">1 Ay</div></div>
        <div class="summaryRow"><div>Kota</div><div id="summaryQuota" class="muted">-</div></div>
        <div class="summaryRow"><div>Toplam</div><div id="summaryTotal" class="muted">$0.00</div></div>

        <button id="payButton" class="cta" disabled>
          <span id="payButtonText">Plan Se√ßin</span>
        </button>

        <div id="statusMsg" class="muted"></div>
        
        <div class="info-box">
          <div><strong>üí≥ Global √ñdeme:</strong> Stripe g√ºvenli √∂deme</div>
          <div><strong>üåç Para Birimi:</strong> USD g√∂sterilir, kartƒ±nƒ±za local currency yansƒ±r</div>
          <div><strong>üõ°Ô∏è G√ºvenlik:</strong> SSL ≈üifreli, PCI DSS uyumlu</div>
        </div>
      </div>
    </div>

    <div class="foot">Herhangi bir sorunda bize WhatsApp'tan ula≈üƒ±n: +90 552 071 0977</div>
  </div>

  <script>
    // ====== CONFIGURATION ======
    const IS_PRODUCTION = window.location.hostname !== 'localhost' && !window.location.hostname.includes('127.0.0.1');
    
    const STRIPE_CONFIG = {
      test: 'pk_test_51Qkq8iCxIA7H9vX1tcASu7lttD28y8uQN2DVIAholUom1MNwEWaEAXFW9lrvyjYjQSR9yLtfsQB3AxrgvN1fnkt00uwkCxEG5',
      live: 'pk_live_51Qkq8iCxIA7H9vX1DvKkU62vcpIsgJzUk2rIDAGaxUMhuWZUrJ5nHoox1WjImEhTM8fvheyOJ4wSD0YXnS8VAkEh00noftlqEM'
    };
    
    const API_CONFIG = {
      local: 'http://localhost:3001',
      production: 'https://satinalmacopilot.com:3001'
    };

    const STRIPE_PUBLISHABLE_KEY = IS_PRODUCTION ? STRIPE_CONFIG.live : STRIPE_CONFIG.test;
    const API_BASE_URL = IS_PRODUCTION ? API_CONFIG.production : API_CONFIG.local;
    
    const SUPABASE_URL = 'https://dblepmaqqkudsbmvlqcw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRibGVwbWFxcWt1ZHNibXZscWN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0NTUzOTksImV4cCI6MjA3MjAzMTM5OX0.yOPbSl2o2LjHNryW0eIfKeJa5YJgBC94GWzswlclPWg';

    let stripe = null;
    let selectedPlan = null;
    let selectedBilling = 'yearly';
    let currentUser = null;

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    const params = new URLSearchParams(location.search);
    const urlPref = {
      phone: params.get('phone') || '',
      plan: (params.get('plan') || '').toLowerCase(),
      billing: (params.get('billing') || '').toLowerCase(),
      return_user: params.get('return_user') === 'true',
      reason: params.get('reason') || ''
    };

    function formatMoney(n){ return '$' + Number(n||0).toFixed(2) }
    function normalizePhone(v){ return (v||'').replace(/[^\d+]/g,'') }

    function showLoading(message = 'ƒ∞≈üleniyor...') {
      $('#loadingText').textContent = message;
      $('#loadingOverlay').style.display = 'flex';
    }

    function hideLoading() {
      $('#loadingOverlay').style.display = 'none';
    }

    function paintPlanCards(){
      const yearly = selectedBilling === 'yearly';
      $$('#plans .plan').forEach(card=>{
        const mp = Number(card.dataset.monthlyPrice);
        const yp = Number(card.dataset.yearlyPrice);
        const mq = Number(card.dataset.monthlyQuota);
        const yq = Number(card.dataset.yearlyQuota);
        
        if (yearly) {
          card.querySelector('[data-price]').textContent = `$${yp}/ay`;
          const savings = ((mp * 12 - yp * 12) / (mp * 12) * 100).toFixed(0);
          card.querySelector('[data-quota]').textContent = `${yq.toLocaleString('tr-TR')} mesaj (${savings}% tasarruf)`;
        } else {
          card.querySelector('[data-price]').textContent = `$${mp}/ay`;
          card.querySelector('[data-quota]').textContent = `${mq.toLocaleString('tr-TR')} mesaj`;
        }
      });
    }

    function updateSummary(){
      const yearly = selectedBilling === 'yearly';
      $('#summaryDuration').textContent = yearly ? '1 Yƒ±l (aylƒ±k faturalama)' : '1 Ay';

      if(!selectedPlan){
        $('#summaryPlan').textContent = 'Se√ßiniz';
        $('#summaryQuota').textContent = '-';
        $('#summaryTotal').textContent = '$0.00';
        $('#payButton').disabled = true;
        $('#payButtonText').textContent = 'Plan Se√ßin';
        return;
      }
      
      const card = $(`.plan[data-plan="${selectedPlan}"]`);
      const price = Number(card.dataset[yearly ? 'yearlyPrice':'monthlyPrice']);
      const quota = Number(card.dataset[yearly ? 'yearlyQuota':'monthlyQuota']);
      
      $('#summaryPlan').textContent = card.querySelector('.planTitle').textContent.trim();
      $('#summaryQuota').textContent = quota.toLocaleString('tr-TR') + ' mesaj';
      
      if (yearly) {
        $('#summaryTotal').textContent = `${formatMoney(price)}/ay (yƒ±llƒ±k ${formatMoney(price * 12)})`;
      } else {
        $('#summaryTotal').textContent = formatMoney(price);
      }
      
      $('#payButton').disabled = false;
      $('#payButtonText').textContent = yearly ? `${formatMoney(price * 12)} √ñde (Yƒ±llƒ±k)` : `${formatMoney(price)} √ñde`;
    }

    function selectPlan(plan){
      selectedPlan = plan;
      $$('#plans .plan').forEach(c => c.dataset.selected = (c.dataset.plan === plan ? 'true':'false'));
      updateSummary();
    }

    function setBilling(mode){
      selectedBilling = mode;
      $('#billingSwitch').dataset.mode = mode;
      paintPlanCards();
      updateSummary();
    }

    async function fetchUserByPhone(phone){
      const clean = normalizePhone(phone);
      if(!clean) return null;
      try {
        const url = `${SUPABASE_URL}/rest/v1/customers?contact_phone=eq.${encodeURIComponent(clean)}&select=*`;
        const res = await fetch(url, { 
          headers:{ 
            apikey: SUPABASE_ANON_KEY, 
            Authorization: `Bearer ${SUPABASE_ANON_KEY}` 
          }
        });
        const data = await res.json();
        return data && data[0] ? data[0] : null;
      } catch (error) {
        console.error('User fetch error:', error);
        return null;
      }
    }

    function showPassiveBanner(visible){
      const el = $('#passiveBanner');
      if(visible) el.classList.add('show'); else el.classList.remove('show');
    }

    async function bootstrap(){
      console.log('üîß Environment:', IS_PRODUCTION ? 'PRODUCTION' : 'TEST');
      console.log('üîë Stripe Key:', STRIPE_PUBLISHABLE_KEY.substring(0, 20) + '...');
      console.log('üåê API URL:', API_BASE_URL);

      if (window.Stripe && STRIPE_PUBLISHABLE_KEY) {
        try {
          stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
          console.log('‚úÖ Stripe initialized');
        } catch (error) {
          console.error('‚ùå Stripe initialization failed:', error);
          alert('Stripe y√ºklenemedi. Sayfayƒ± yenileyin.');
          return;
        }
      } else {
        console.error('‚ùå Stripe SDK not loaded');
        alert('√ñdeme sistemi y√ºklenemedi. Sayfayƒ± yenileyin.');
        return;
      }

      if(urlPref.billing === 'yearly' || urlPref.billing === 'monthly') {
        setBilling(urlPref.billing);
      } else {
        setBilling('yearly');
      }

      paintPlanCards();

      if(urlPref.plan && ['basic','pro','max'].includes(urlPref.plan)) {
        selectPlan(urlPref.plan);
      } else {
        selectPlan('pro');
      }

      if(urlPref.phone){
        $('#phone').value = urlPref.phone;
        currentUser = await fetchUserByPhone(urlPref.phone);
      }

      if(currentUser){
        if(currentUser.name) $('#fullName').value = currentUser.name;
        if(currentUser.company_name) $('#company').value = currentUser.company_name;

        const now = new Date();
        const trialEnd = currentUser.trial_end_date ? new Date(currentUser.trial_end_date) : null;
        const planEnd = currentUser.plan_end_date ? new Date(currentUser.plan_end_date) : null;
        let status = (currentUser.subscription_status||'').toLowerCase();
        
        if(status === 'trial' && trialEnd && trialEnd < now) status = 'passive';
        if(status === 'active' && planEnd && planEnd < now) status = 'passive';
        if(currentUser.used_quota >= (currentUser.monthly_quota||0)) status = 'passive';

        showPassiveBanner(status === 'passive');
        
        if (urlPref.return_user) {
          let message = '';
          switch(urlPref.reason) {
            case 'trial_expired':
              message = 'Trial s√ºreniz sona erdi. Devam etmek i√ßin bir plan se√ßin.';
              break;
            case 'quota_exceeded':
              message = 'Mesaj kotanƒ±z doldu. Plan y√ºkseltin veya yenileyin.';
              break;
            default:
              message = 'Hesabƒ±nƒ±zƒ± yeniden aktifle≈ütirmek i√ßin bir plan se√ßin.';
          }
          $('#statusMsg').textContent = message;
          $('#statusMsg').style.color = '#f6a609';
        }
      }

      updateSummary();
    }

    $$('#plans .plan').forEach(card=>{
      card.addEventListener('click', ()=> selectPlan(card.dataset.plan));
    });

    $('#billingSwitch').addEventListener('click', ()=>{
      setBilling(selectedBilling === 'monthly' ? 'yearly' : 'monthly');
    });

    async function createStripeCheckout(payload){
      try {
        console.log('üì§ API Request:', {
          url: `${API_BASE_URL}/api/payment/create-checkout-session`,
          payload: payload
        });

        const response = await fetch(`${API_BASE_URL}/api/payment/create-checkout-session`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('‚ùå API Error Response:', errorText);
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const session = await response.json();
        console.log('‚úÖ API Response:', session);
        
        return session;
      } catch (error) {
        console.error('üî• API Error:', error);
        throw error;
      }
    }

    $('#payButton').addEventListener('click', async ()=>{
      const name = $('#fullName').value.trim();
      const company = $('#company').value.trim();
      const phone = normalizePhone($('#phone').value);

      if(!name || !company || !phone){ 
        alert('Ad Soyad, ≈ûirket ve Telefon gereklidir.'); 
        return; 
      }
      if(!selectedPlan){ 
        alert('L√ºtfen bir plan se√ßin.'); 
        return; 
      }

      const yearly = selectedBilling === 'yearly';
      const card = $(`.plan[data-plan="${selectedPlan}"]`);
      const monthlyPrice = Number(card.dataset.monthlyPrice);
      const yearlyPrice = Number(card.dataset.yearlyPrice);
      const price = yearly ? yearlyPrice : monthlyPrice;
      const quota = Number(card.dataset[yearly ? 'yearlyQuota':'monthlyQuota']);

      $('#payButton').disabled = true;
      $('#payButtonText').textContent = 'Hazƒ±rlanƒ±yor...';
      showLoading('G√ºvenli √∂deme sayfasƒ± hazƒ±rlanƒ±yor...');

      const payload = {
        customer: {
          name, 
          company, 
          phone,
          email: currentUser?.email || `${phone.replace(/[^\d]/g, '')}@temp.com`
        },
        plan: selectedPlan,
        billing: selectedBilling,
        price: yearly ? yearlyPrice * 12 : monthlyPrice,
        monthlyPrice: yearly ? yearlyPrice : monthlyPrice,
        quota,
        context: currentUser?.subscription_status || 'new',
        success_url: `${window.location.origin}/success.html?session_id={CHECKOUT_SESSION_ID}`,
        cancel_url: `${window.location.origin}/payment.html?phone=${encodeURIComponent(phone)}&plan=${selectedPlan}&billing=${selectedBilling}&canceled=true`
      };

      try {
        const session = await createStripeCheckout(payload);
        
        const sessionId = session.session_id || session.sessionId;
        const checkoutUrl = session.checkout_url || session.url;

        console.log('üîë Session ID:', sessionId);
        console.log('üîó Checkout URL:', checkoutUrl);

        if (!sessionId) {
          throw new Error('Checkout session ID alƒ±namadƒ±. Backend response: ' + JSON.stringify(session));
        }

        hideLoading();
        $('#statusMsg').textContent = 'Stripe √∂deme sayfasƒ±na y√∂nlendiriliyorsunuz...';
        $('#statusMsg').style.color = '#19c37d';
        
        if (stripe) {
          console.log('üöÄ Redirecting via Stripe.js...');
          const { error } = await stripe.redirectToCheckout({ sessionId });
          
          if (error) {
            throw new Error('Stripe redirect error: ' + error.message);
          }
        } else if (checkoutUrl) {
          console.log('üöÄ Redirecting via direct URL...');
          window.location.href = checkoutUrl;
        } else {
          throw new Error('Ne Stripe instance ne de checkout URL mevcut');
        }

      } catch(err) {
        console.error('üí• Payment error:', err);
        hideLoading();
        
        $('#payButton').disabled = false;
        $('#payButtonText').textContent = yearly ? `${formatMoney(yearlyPrice * 12)} √ñde (Yƒ±llƒ±k)` : `${formatMoney(monthlyPrice)} √ñde`;
        $('#statusMsg').textContent = '√ñdeme ba≈ülatƒ±lƒ±rken hata: ' + err.message;
        $('#statusMsg').style.color = '#ff6b6b';
        
        alert(`‚ùå √ñdeme i≈ülemi ba≈ülatƒ±lamadƒ±\n\n${err.message}\n\nDestek:\nüìß info@satinalmacopilot.com\nüì± WhatsApp: +90 552 071 0977`);
      }
    });

    window.addEventListener('DOMContentLoaded', bootstrap);
  </script>
</body>
</html>
