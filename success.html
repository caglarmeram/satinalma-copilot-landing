<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ödeme Başarılı - Satınalma CoPilot</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #10b981, #059669);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .success-container {
            background: white;
            border-radius: 20px;
            padding: 60px 40px;
            max-width: 700px;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            animation: slideUp 0.8s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .success-icon {
            font-size: 4rem;
            margin-bottom: 24px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .success-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 16px;
        }

        .success-subtitle {
            font-size: 1.2rem;
            color: #64748b;
            margin-bottom: 40px;
            line-height: 1.6;
        }

        .user-info-card {
            background: #f8fafc;
            border-radius: 16px;
            padding: 30px;
            margin: 30px 0;
            text-align: left;
            border-left: 4px solid #10b981;
        }

        .user-info-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 20px;
            text-align: center;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #64748b;
            font-weight: 500;
        }

        .info-value {
            color: #1e293b;
            font-weight: 600;
        }

        .status-badge {
            background: #dcfce7;
            color: #166534;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .quota-display {
            background: #f0fdf4;
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 20px;
            margin: 30px 0;
        }

        .quota-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #059669;
            margin-bottom: 8px;
        }

        .quota-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: #10b981;
            margin-bottom: 4px;
        }

        .quota-label {
            color: #059669;
            font-weight: 500;
        }

        .whatsapp-info {
            background: #dcfce7;
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 20px;
            margin: 30px 0;
        }

        .whatsapp-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #059669;
            margin: 8px 0;
        }

        .whatsapp-button {
            background: #25d366;
            color: white;
            text-decoration: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .whatsapp-button:hover {
            background: #20c757;
            transform: translateY(-2px);
        }

        .steps-container {
            background: #f8fafc;
            border-radius: 16px;
            padding: 30px;
            margin: 40px 0;
            text-align: left;
        }

        .steps-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 20px;
            text-align: center;
        }

        .step {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 20px;
            padding: 16px;
            background: white;
            border-radius: 12px;
            border-left: 4px solid #10b981;
        }

        .step:last-child {
            margin-bottom: 0;
        }

        .step-number {
            background: #10b981;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        .step-content h4 {
            color: #1e293b;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .step-content p {
            color: #64748b;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .trial-info {
            background: #fef3c7;
            border-radius: 12px;
            padding: 20px;
            margin: 30px 0;
        }

        .trial-countdown {
            font-size: 1.1rem;
            font-weight: 600;
            color: #92400e;
        }

        .footer-links {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #e2e8f0;
        }

        .footer-links a {
            color: #2563eb;
            text-decoration: none;
            margin: 0 16px;
            font-weight: 500;
        }

        .footer-links a:hover {
            text-decoration: underline;
        }

        .example-messages {
            background: #f1f5f9;
            border-radius: 12px;
            padding: 20px;
            margin: 30px 0;
            text-align: left;
        }

        .example-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 12px;
            text-align: center;
        }

        .example-message {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
            font-style: italic;
            color: #475569;
            border-left: 3px solid #10b981;
        }

        @media (max-width: 768px) {
            .success-container {
                padding: 40px 24px;
                margin: 10px;
            }
            
            .success-title {
                font-size: 2rem;
            }
            
            .user-info-card {
                padding: 20px;
            }
            
            .info-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
        }
    </style>
</head>
<body>
    <div class="success-container">
        <div class="success-icon">🎉</div>
        <h1 class="success-title" id="mainTitle">Ödeme Başarılı!</h1>
        <p class="success-subtitle" id="mainSubtitle">
            Hoş geldiniz! WhatsApp asistanınızla tanışma zamanı.
        </p>
        
        <div class="user-info-card" id="userInfoCard">
            <h3 class="user-info-title">Hesap Bilgileriniz</h3>
            <div class="info-item">
                <span class="info-label">Ad Soyad:</span>
                <span class="info-value" id="userName">Yükleniyor...</span>
            </div>
            <div class="info-item">
                <span class="info-label">Şirket:</span>
                <span class="info-value" id="companyName">Yükleniyor...</span>
            </div>
            <div class="info-item">
                <span class="info-label">WhatsApp:</span>
                <span class="info-value" id="phoneNumber">Yükleniyor...</span>
            </div>
            <div class="info-item">
                <span class="info-label">Plan:</span>
                <span class="info-value" id="planName">Yükleniyor...</span>
            </div>
            <div class="info-item">
                <span class="info-label">Durum:</span>
                <span class="status-badge" id="statusBadge">Aktif</span>
            </div>
        </div>

        <div class="quota-display" id="quotaDisplay">
            <div class="quota-title">Mesaj Hakkınız</div>
            <div class="quota-number" id="quotaNumber">1000</div>
            <div class="quota-label" id="quotaLabel">mesaj hakkı</div>
        </div>
        
        <div class="whatsapp-info">
            <p><strong>WhatsApp Asistan Numarası:</strong></p>
            <div class="whatsapp-number">+1 (415) 523-8886</div>
            <p>Bu numarayı WhatsApp'ta kaydedin ve ilk mesajınızı atın!</p>
            <a href="https://wa.me/14155238886?text=Merhaba" class="whatsapp-button" target="_blank">
                📱 WhatsApp'ta Mesaj Gönder
            </a>
        </div>
        
        <div class="steps-container">
            <h3 class="steps-title">🚀 Başlamak için 3 basit adım:</h3>
            
            <div class="step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <h4>WhatsApp'ta Numarayı Kaydedin</h4>
                    <p>+1 (415) 523-8886 numarasını "Satınalma CoPilot" adıyla WhatsApp'ta kaydedin</p>
                </div>
            </div>
            
            <div class="step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <h4>İlk Mesajınızı Atın</h4>
                    <p>"Merhaba" yazarak asistanınızı aktifleştirin</p>
                </div>
            </div>
            
            <div class="step">
                <div class="step-number">3</div>
                <div class="step-content">
                    <h4>Satınalma İhtiyaçlarınızı Paylaşın</h4>
                    <p>"500 kg demir profil lazım" gibi ihtiyaçlarınızı doğal dille yazın</p>
                </div>
            </div>
        </div>

        <div class="example-messages">
            <h4 class="example-title">💡 İlk Deneme Önerileri:</h4>
            <div class="example-message">"Hangi firmalar alüminyum profil üretiyor?"</div>
            <div class="example-message">"Bosch Türkiye hakkında risk analizi"</div>
            <div class="example-message">"Plastik ambalaj pazarı nasıl?"</div>
            <div class="example-message">"RFQ başlat: 1000 adet vida"</div>
        </div>
        
        <div class="trial-info" id="trialInfo">
            <p><strong>🎁 Plan Durumunuz:</strong></p>
            <div class="trial-countdown" id="trialCountdown">Aktif</div>
            <p style="margin-top: 8px; font-size: 0.9rem; color: #92400e;" id="trialDetails">
                Mesaj hakkınız yüklendi. WhatsApp asistanınız hazır!
            </p>
        </div>
        
        <div class="footer-links">
            <a href="mailto:info@satinalmacopilot.com">📧 Destek</a>
            <a href="tel:+905520710977">📞 Yardım</a>
            <a href="index.html">🏠 Ana Sayfa</a>
        </div>
    </div>
    
    <script>
        // Configuration
        const SUPABASE_URL = 'https://dblepmaqqkudsbmvlqcw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRibGVwbWFxcWt1ZHNibXZscWN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0NTUzOTksImV4cCI6MjA3MjAzMTM5OX0.yOPbSl2o2LjHNryW0eIfKeJa5YJgBC94GWzswlclPWg';

        // URL parameters for Stripe integration
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session_id');
        const userPhone = urlParams.get('phone');
        const selectedPlan = urlParams.get('plan');
        const paymentStatus = urlParams.get('payment_status');

        // Main initialization
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Success page loaded:', { sessionId, userPhone, selectedPlan, paymentStatus });
            
            if (sessionId) {
                // Stripe success flow
                await handleStripeSuccess(sessionId);
            } else if (userPhone) {
                // Direct user data loading
                await loadUserData(userPhone);
            } else {
                // Fallback
                showDefaultSuccess();
            }

            setupAutoRedirect();
        });

        async function handleStripeSuccess(sessionId) {
            try {
                // Call backend to verify Stripe session and get user data
                const response = await fetch('/api/verify-stripe-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ session_id: sessionId })
                });

                if (response.ok) {
                    const data = await response.json();
                    displayUserInfo(data.customer);
                    updatePageForPaymentSuccess(data.customer);
                } else {
                    throw new Error('Session verification failed');
                }
            } catch (error) {
                console.error('Stripe session verification error:', error);
                showDefaultSuccess();
            }
        }

        async function loadUserData(phone) {
            try {
                const cleanPhone = phone.replace(/[^\d+]/g, '');
                const response = await fetch(`${SUPABASE_URL}/rest/v1/customers?contact_phone=eq.${encodeURIComponent(cleanPhone)}&select=*`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                const users = await response.json();
                
                if (users.length > 0) {
                    const user = users[0];
                    displayUserInfo(user);
                    updatePageContent(user);
                } else {
                    showDefaultSuccess();
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
                showDefaultSuccess();
            }
        }

        function displayUserInfo(user) {
            document.getElementById('userName').textContent = user.name || 'Belirtilmemiş';
            document.getElementById('companyName').textContent = user.company_name || 'Belirtilmemiş';
            document.getElementById('phoneNumber').textContent = user.contact_phone || 'Belirtilmemiş';
            document.getElementById('planName').textContent = (user.subscription_plan || 'trial').toUpperCase();
            
            // Update quota display
            const quota = user.monthly_quota || 1000;
            document.getElementById('quotaNumber').textContent = quota.toLocaleString();
            
            const billing = user.billing_cycle || 'monthly';
            if (user.subscription_status === 'trial') {
                document.getElementById('quotaLabel').textContent = 'mesaj (deneme)';
            } else {
                document.getElementById('quotaLabel').textContent = `mesaj (${billing === 'monthly' ? '1 ay' : '1 yıl'})`;
            }
        }

        function updatePageForPaymentSuccess(user) {
            // Payment successful - show paid plan details
            document.getElementById('mainTitle').textContent = 'Ödeme Başarılı!';
            document.getElementById('mainSubtitle').textContent = 'Planınız aktifleştirildi. WhatsApp asistanınız hazır!';
            document.getElementById('statusBadge').textContent = 'Aktif';
            document.getElementById('statusBadge').style.background = '#dcfce7';
            document.getElementById('statusBadge').style.color = '#166534';
            
            // Update trial info section for paid plans
            const planEnd = user.plan_end_date ? new Date(user.plan_end_date) : null;
            if (planEnd) {
                const now = new Date();
                const remainingDays = Math.ceil((planEnd - now) / (1000 * 60 * 60 * 24));
                document.getElementById('trialCountdown').textContent = `${remainingDays} gün aktif`;
                document.getElementById('trialDetails').textContent = `Planınız ${planEnd.toLocaleDateString('tr-TR')} tarihine kadar geçerli.`;
            } else {
                document.getElementById('trialCountdown').textContent = 'Plan Aktif';
                document.getElementById('trialDetails').textContent = 'Mesaj hakkınız yüklendi. WhatsApp asistanınız hazır!';
            }
        }

        function updatePageContent(user) {
            const now = new Date();
            const trialEnd = user.trial_end_date ? new Date(user.trial_end_date) : null;
            const planEnd = user.plan_end_date ? new Date(user.plan_end_date) : null;

            if (user.subscription_status === 'trial' && trialEnd && trialEnd > now) {
                // Trial user
                document.getElementById('mainTitle').textContent = 'Ücretsiz Deneme Başladı!';
                document.getElementById('mainSubtitle').textContent = '14 günlük ücretsiz deneme süreniz başladı.';
                document.getElementById('statusBadge').textContent = 'Trial Aktif';
                document.getElementById('statusBadge').style.background = '#fef3c7';
                document.getElementById('statusBadge').style.color = '#92400e';
                
                const remainingDays = Math.ceil((trialEnd - now) / (1000 * 60 * 60 * 24));
                document.getElementById('trialCountdown').textContent = `${remainingDays} gün kaldı`;
                document.getElementById('trialDetails').textContent = `${user.monthly_quota || 1000} mesaj hakkınız var. Süre veya kota bittiğinde plan seçimi gerekli.`;
            } else if (user.subscription_status === 'active' && planEnd && planEnd > now) {
                // Active paid user
                updatePageForPaymentSuccess(user);
            } else {
                // Expired user
                document.getElementById('mainTitle').textContent = 'Hesap Bulundu!';
                document.getElementById('mainSubtitle').textContent = 'Ancak aboneliğinizin süresi dolmuş.';
                document.getElementById('statusBadge').textContent = 'Süresi Dolmuş';
                document.getElementById('statusBadge').style.background = '#fecaca';
                document.getElementById('statusBadge').style.color = '#991b1b';
                
                document.getElementById('trialCountdown').textContent = 'Plan Yenileme Gerekli';
                document.getElementById('trialDetails').innerHTML = 'Devam etmek için <a href="payment.html?phone=' + encodeURIComponent(user.contact_phone) + '" style="color: #2563eb;">plan yenileyin</a>.';
            }
        }

        function showDefaultSuccess() {
            // Default success message when user data is not available
            document.getElementById('userName').textContent = 'Kullanıcı';
            document.getElementById('companyName').textContent = 'Şirket';
            document.getElementById('phoneNumber').textContent = userPhone || 'Telefon';
            document.getElementById('planName').textContent = selectedPlan ? selectedPlan.toUpperCase() : 'TRIAL';
            document.getElementById('quotaNumber').textContent = '1000';
            document.getElementById('quotaLabel').textContent = 'mesaj hakkı';
            
            if (paymentStatus === 'success') {
                updatePageForPaymentSuccess({
                    subscription_status: 'active',
                    subscription_plan: selectedPlan || 'pro',
                    monthly_quota: 1000
                });
            }
        }

        function setupAutoRedirect() {
            // Auto-open WhatsApp after 8 seconds (optional)
            setTimeout(() => {
                if (confirm('WhatsApp\'ı şimdi açmak ister misiniz?')) {
                    const message = sessionId ? 'Merhaba, ödeme yaptım' : 'Merhaba, yeni kaydoldum';
                    window.open(`https://wa.me/14155238886?text=${encodeURIComponent(message)}`, '_blank');
                }
            }, 8000);
        }

        // Analytics tracking
        if (sessionId) {
            console.log('Stripe payment completed:', sessionId);
            // Add analytics tracking here
        }
    </script>
</body>
</html>
